<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ¯ç‰‡è®¾è®¡å·¥å…·</title>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #00c853;
            --dark-bg: #121212;
            --panel-bg: #1e1e1e;
            --grid-color: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #9e9e9e;
            --border-color: #333;
            --transistor-n: #4fc3f7;
            --transistor-p: #f06292;
            --port-in: #81c784;
            --port-out: #ff8a65;
            --vcc: #f44336;
            --gnd: #9e9e9e;
            --wire-color: #ffd54f;
            --via-color: #ff9800;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            padding: 12px 24px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        
        .logo {
            display: flex;
            align-items: center;
            margin-right: 30px;
        }
        
        .logo-icon {
            font-size: 28px;
            margin-right: 12px;
        }
        
        .logo-text {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .toolbar {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .btn.active {
            background: var(--secondary);
            box-shadow: 0 0 15px rgba(0, 200, 83, 0.4);
        }
        
        .btn-icon {
            font-size: 18px;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 280px;
            background-color: var(--panel-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::after {
            content: "";
            flex: 1;
            height: 1px;
            background-color: var(--border-color);
            margin-left: 10px;
        }
        
        .components-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .component-item {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .component-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }
        
        .component-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .component-name {
            font-size: 14px;
            text-align: center;
        }
        
        .layers-control {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .layer-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .layer-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .layer-option.active {
            background: rgba(26, 115, 232, 0.2);
            border-left: 3px solid var(--primary);
        }
        
        .layer-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 12px;
        }
        
        .layer-name {
            font-size: 14px;
            flex: 1;
        }
        
        .layer-visibility {
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .layer-visibility:hover {
            opacity: 1;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #0a0a0a;
            cursor: grab;
        }
        
        .canvas-container.dragging {
            cursor: grabbing;
        }
        
        #circuit-canvas {
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--dark-bg);
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .zoom-controls {
            position: absolute;
            right: 20px;
            bottom: 20px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .status-bar {
            background-color: var(--panel-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            border-top: 1px solid var(--border-color);
        }
        
        .mode-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mode-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--secondary);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: var(--panel-bg);
            width: 80%;
            min-width: 800px;
            height: 90%;
            max-width: 90%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .json-preview {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 15px;
            height: calc(100% - 40px); /* ç•™å‡ºæ ‡é¢˜æ ç©ºé—´ */
            flex: 1;
            overflow-y: auto; /* ä»…ä¿ç•™å‚ç›´æ»šåŠ¨ */
            overflow-x: hidden; /* ç¦ç”¨æ°´å¹³æ»šåŠ¨ */
            white-space: pre;
            line-height: 1.6;
        }
        
        .file-import {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .file-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }
        
        .file-input:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .btn-primary {
            background-color: var(--primary);
        }
        
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        /* Transistor styling */
        .transistor {
            stroke-width: 2;
            cursor: move;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill-opacity: 0.2;
        }
        
        .transistor.nmos {
            stroke: var(--transistor-n);
            fill: var(--transistor-n);
        }
        
        .transistor.pmos {
            stroke: var(--transistor-p);
            fill: var(--transistor-p);
        }
        
        .pin {
            fill: #555;
            stroke: #999;
            stroke-width: 1;
            cursor: pointer;
            r: 5;
        }
        
        .pin:hover {
            fill: var(--wire-color);
            stroke: #fff;
            r: 6;
        }
        
        .wire {
            stroke-width: 2;
            pointer-events: none;
        }
        
        .via {
            fill: var(--via-color);
            stroke: #ff6d00;
            stroke-width: 1;
            r: 3;
        }
        
        .port {
            stroke-width: 2;
            cursor: move;
            fill-opacity: 0.2;
        }
        
        .port.input {
            stroke: var(--port-in);
            fill: var(--port-in);
        }
        
        .port.output {
            stroke: var(--port-out);
            fill: var(--port-out);
        }
        
        .port.vcc {
            stroke: var(--vcc);
            fill: var(--vcc);
        }
        
        .port.gnd {
            stroke: var(--gnd);
            fill: var(--gnd);
        }
        
        .component-label {
            fill: var(--text-primary);
            font-size: 10px;
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
        }

        /* æ·»åŠ çš„æ ·å¼ç”¨äºè¿æ¥æŒ‡ç¤º */
        .connection-indicator {
            stroke: #00ff00;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary);
            background: rgba(26, 115, 232, 0.2);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        .module-container {
            stroke: #4285F4;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 5,5;
        }
        .module-label {
            fill: #4285F4;
            font-size: 14px;
            font-weight: bold;
        }
        .fixed-wire {
            stroke-width: 2;
            stroke-dasharray: 5,3;
            pointer-events: none;
        }
        .fixed-wire.metal1 {
            stroke: #FFD54F; /* é‡‘å±å±‚1 - é‡‘è‰² */
        }
    
        .fixed-wire.metal2 {
            stroke: #FF9800; /* é‡‘å±å±‚2 - æ©™è‰² */
        }
    
        .fixed-wire.metal3 {
            stroke: #4FC3F7; /* é‡‘å±å±‚3 - è“è‰² */
        }
    
        .fixed-wire.metal4 {
            stroke: #81C784; /* é‡‘å±å±‚4 - ç»¿è‰² */
        }
    
        .fixed-wire.metal5 {
            stroke: #BA68C8; /* é‡‘å±å±‚5 - ç´«è‰² */
        }
    
        .fixed-via {
            fill: #FF5722; /* è¿‡å­” - çº¢è‰² */
            stroke: #E64A19;
            stroke-width: 1;
        }
        /* æ–°å¢ä»¿çœŸé¢æ¿æ ·å¼ */
        .simulation-panel {
            width: 280px;
            background-color: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            display: none; /* é»˜è®¤éšè— */
        }
        
        .simulation-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .simulation-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .inputs-section, .outputs-section {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .input-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }
        
        .input-name {
            font-weight: 500;
        }
        
        .input-toggle {
            display: flex;
            gap: 8px;
        }
        
        .toggle-btn {
            width: 40px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
        }
        
        .toggle-btn.active {
            background: var(--primary);
        }
        
        .output-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .output-value {
            font-weight: bold;
            color: var(--secondary);
        }
        
        .run-simulation {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .run-simulation:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">âš¡</div>
            <div class="logo-text">ChipDesigner</div>
        </div>
        <div class="toolbar">
            <button class="btn" id="verilog-btn">
                <span class="btn-icon">ğŸ“</span> ç¼–å†™Verilog
            </button>
            <button class="btn active" id="select-mode-btn">
                <span class="btn-icon">ğŸ”§</span> é€‰æ‹©æ¨¡å¼
            </button>
            <button class="btn" id="wire-mode-btn">
                <span class="btn-icon">ğŸ”Œ</span> è¿çº¿æ¨¡å¼
            </button>
            <button class="btn" id="export-btn">
                <span class="btn-icon">ğŸ“</span> è¿›è¡Œå¸ƒå±€
            </button>
            <button class="btn" id="import-btn">
                <span class="btn-icon">ğŸ“‚</span> å¯¼å…¥æ–‡ä»¶
            </button>
            <button class="btn" id="delete-mode-btn">
                <span class="btn-icon">ğŸ—‘ï¸</span> åˆ é™¤æ¨¡å¼
            </button>
            <button class="btn" id="show-all-layers">
                <span class="btn-icon">ğŸ‘ï¸</span> æ˜¾ç¤ºæ‰€æœ‰å±‚
            </button>
            <button class="btn" id="simulation-btn">
                <span class="btn-icon">ğŸ“ŠğŸ“Š</span> ä»¿çœŸæ¨¡å¼
            </button>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="section-title">
                <span>ç”µè·¯å…ƒä»¶</span>
            </div>
            <div class="components-grid">
                <div class="component-item" data-type="nmos">
                    <div class="component-icon" style="color: var(--transistor-n);">N</div>
                    <div class="component-name">NMOS æ™¶ä½“ç®¡</div>
                </div>
                <div class="component-item" data-type="pmos">
                    <div class="component-icon" style="color: var(--transistor-p);">P</div>
                    <div class="component-name">PMOS æ™¶ä½“ç®¡</div>
                </div>
                <div class="component-item" data-type="input">
                    <div class="component-icon" style="color: var(--port-in);">â†’</div>
                    <div class="component-name">è¾“å…¥ç«¯å£</div>
                </div>
                <div class="component-item" data-type="output">
                    <div class="component-icon" style="color: var(--port-out);">â†</div>
                    <div class="component-name">è¾“å‡ºç«¯å£</div>
                </div>
                <div class="component-item" data-type="vcc">
                    <div class="component-icon" style="color: var(--vcc);">+</div>
                    <div class="component-name">ç”µæº (VCC)</div>
                </div>
                <div class="component-item" data-type="gnd">
                    <div class="component-icon" style="color: var(--gnd);">-</div>
                    <div class="component-name">æ¥åœ° (GND)</div>
                </div>
            </div>
            
            <div class="section-title">
                <span>å¸ƒçº¿å±‚ (ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤º)</span>
            </div>
            <div class="layers-control">
                <div class="layer-option active" data-layer="metal1">
                    <div class="layer-color" style="background-color: #ffd54f;"></div>
                    <div class="layer-name">é‡‘å±å±‚ 1 (æ°´å¹³)</div>
                    <svg class="layer-visibility" viewBox="0 0 24 24" fill="white">
                        <path d="M12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5zM3.18 12c1.46 3.36 4.72 5.5 8.82 5.5s7.36-2.14 8.82-5.5C19.36 8.64 16.1 6.5 12 6.5S4.64 8.64 3.18 12z"/>
                    </svg>
                </div>
                <div class="layer-option active" data-layer="metal2">
                    <div class="layer-color" style="background-color: #ff9800;"></div>
                    <div class="layer-name">é‡‘å±å±‚ 2 (å‚ç›´)</div>
                    <svg class="layer-visibility" viewBox="0 0 24 24" fill="white">
                        <path d="M12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5zM3.18 12c1.46 3.36 4.72 5.5 8.82 5.5s7.36-2.14 8.82-5.5C19.36 8.64 16.1 6.5 12 6.5S4.64 8.64 3.18 12z"/>
                    </svg>
                </div>
                <div class="layer-option active" data-layer="metal3">
                    <div class="layer-color" style="background-color: #4fc3f7;"></div>
                    <div class="layer-name">é‡‘å±å±‚ 3</div>
                    <svg class="layer-visibility" viewBox="0 0 24 24" fill="white">
                        <path d="M12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5zM3.18 12c1.46 3.36 4.72 5.5 8.82 5.5s7.36-2.14 8.82-5.5C19.36 8.64 16.1 6.5 12 6.5S4.64 8.64 3.18 12z"/>
                    </svg>
                </div>
                <div class="layer-option active" data-layer="metal4">
                    <div class="layer-color" style="background-color: #81c784;"></div>
                    <div class="layer-name">é‡‘å±å±‚ 4</div>
                    <svg class="layer-visibility" viewBox="0 0 24 24" fill="white">
                        <path d="M12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5zM3.18 12c1.46 3.36 4.72 5.5 8.82 5.5s7.36-2.14 8.82-5.5C19.36 8.64 16.1 6.5 12 6.5S4.64 8.64 3.18 12z"/>
                    </svg>
                </div>
                <div class="layer-option active" data-layer="metal5">
                    <div class="layer-color" style="background-color: #ba68c8;"></div>
                    <div class="layer-name">é‡‘å±å±‚ 5</div>
                    <svg class="layer-visibility" viewBox="0 0 24 24" fill="white">
                        <path d="M12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5zM3.18 12c1.46 3.36 4.72 5.5 8.82 5.5s7.36-2.14 8.82-5.5C19.36 8.64 16.1 6.5 12 6.5S4.64 8.64 3.18 12z"/>
                    </svg>
                </div>
            </div>
            
            <div class="section-title">
                <span>ç”µè·¯ä¿¡æ¯</span>
            </div>
            <div class="module-info">
                <div>æ™¶ä½“ç®¡æ•°é‡: <span id="transistor-count">0</span></div>
                <div>ç«¯å£æ•°é‡: <span id="port-count">0</span></div>
                <div>è¿æ¥æ•°é‡: <span id="connection-count">0</span></div>
                <div>é‡‘å±å±‚: <span id="layer-count">5</span></div>
            </div>
        </div>
        
        <div class="canvas-container">
            <svg id="circuit-canvas" width="10000" height="10000"></svg>
            
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-in">+</button>
                <button class="zoom-btn" id="zoom-out">-</button>
                <button class="zoom-btn" id="zoom-reset">â†º</button>
            </div>
        </div>

        <!-- æ–°å¢ä»¿çœŸé¢æ¿ -->
        <div class="simulation-panel">
            <div class="simulation-header">
                <h3>ç”µè·¯ä»¿çœŸ</h3>
                <p id="simulation-description">é€‰æ‹©ä»¿çœŸæ¨¡å¼ä»¥åŠ è½½è¾“å…¥è¾“å‡º</p>
            </div>
            
            <div class="simulation-controls">
                <div class="inputs-section">
                    <div class="section-title">è¾“å…¥ç«¯å£</div>
                    <div id="input-controls"></div>
                </div>
                
                <div class="outputs-section">
                    <div class="section-title">è¾“å‡ºç«¯å£</div>
                    <div id="output-display"></div>
                </div>
                
                <button class="run-simulation" id="run-simulation">è¿è¡Œä»¿çœŸ</button>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="mode-indicator">
            <div class="mode-dot"></div>
            <div>å½“å‰æ¨¡å¼: <span id="current-mode">é€‰æ‹©æ¨¡å¼</span></div>
        </div>
        <div>åæ ‡: <span id="cursor-position">(0, 0)</span> | ç¼©æ”¾: <span id="zoom-level">100%</span> | ç½‘æ ¼: 20px | å½“å‰å±‚: <span id="current-layer">metal1</span></div>
    </div>

    <div class="modal" id="verilog-modal">
        <div class="modal-content" style="width: 76%;">
            <div class="modal-header">ç¼–å†™Verilogæ–‡ä»¶ï¼Œéœ€è¦å¸ƒå±€çš„æ¨¡å—è¯·å‘½åä¸ºtop_module</div>
            <textarea id="verilog-editor" style="width: 100%; height: 80%; background: #1e1e1e; color: #e0e0e0; border: 1px solid #333; padding: 10px; font-family: monospace; font-size: 14px;"></textarea>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-verilog">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="save-verilog">ä¿å­˜å¹¶é¢„è§ˆ</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="export-modal">
        <div class="modal-content", style="width: 60%; height: 60%;">
            <div class="modal-header">å¯¼å‡ºç”µè·¯è®¾è®¡</div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="vjson">ç”µè·¯æè¿° (.v.json)</div>
                </div>
                
                <div class="tab-content active" id="vjson-tab">
                    <p>å¯¼å‡ºçš„JSONæ–‡ä»¶å°†åŒ…å«å½“å‰ç”µè·¯çš„æ‰€æœ‰å…ƒä»¶å’Œè¿æ¥å…³ç³»ã€‚</p>
                    <div class="json-preview" id="json-preview">
{
    "top_module": {
        "type": "module",
        "name": "top_module",
        "ports": {
            "input1": {
                "type": "input",
                "out": ["transistor1"]
            },
            "output1": {
                "type": "output",
                "in": ["transistor1"]
            },
            "VCC": {
                "type": "vcc",
                "out": ["transistor2"]
            },
            "GND": {
                "type": "gnd",
                "in": ["transistor1"]
            }
        },
        "mosfets": {
            "transistor1": {
                "type": "nmos",
                "drain": "output1",
                "source": "GND",
                "gate": "input1"
            },
            "transistor2": {
                "type": "pmos",
                "drain": "output1",
                "source": "VCC",
                "gate": "input1"
            }
        },
        "subModules": {}
    }
}
                    </div>
                </div>
                
                <div class="tab-content" id="layout-tab">
                    <p>å¯¼å‡ºçš„å¸ƒå±€æ–‡ä»¶åŒ…å«å…ƒä»¶çš„ä½ç½®ä¿¡æ¯ã€‚</p>
                    <div class="json-preview" id="layout-preview">
{
    "top_module": {
        "inputPorts": ["input1"],
        "isgnd": true,
        "isvcc": true,
        "layout": {
            "height": 200,
            "layer": 1,
            "width": 300,
            "x": 100,
            "y": 100
        },
        "mosfets": {
            "transistor1": {
                "drain": "output1",
                "gate": "input1",
                "layout": {
                    "height": 30,
                    "layer": 1,
                    "width": 40,
                    "x": 150,
                    "y": 150
                },
                "source": "GND",
                "type": "nmos"
            },
            "transistor2": {
                "drain": "output1",
                "gate": "input1",
                "layout": {
                    "height": 30,
                    "layer": 1,
                    "width": 40,
                    "x": 200,
                    "y": 150
                },
                "source": "VCC",
                "type": "pmos"
            }
        },
        "name": "top_module",
        "outputPorts": ["output1"],
        "subModules": {},
        "type": "module"
    }
}
                    </div>
                </div>
                
                <div class="tab-content" id="route-tab">
                    <p>å¯¼å‡ºçš„å¸ƒçº¿æ–‡ä»¶åŒ…å«æ‰€æœ‰è¿çº¿è·¯å¾„ä¿¡æ¯ã€‚</p>
                    <div class="json-preview" id="route-preview">
{
    "top_module": {
        "module_name": "top_module",
        "name": "top_module",
        "nets": [
            {
                "name": "net1",
                "pins": [
                    {
                        "layer": 1,
                        "x": 100,
                        "y": 100
                    },
                    {
                        "layer": 1,
                        "x": 150,
                        "y": 150
                    }
                ],
                "segments": [
                    {
                        "end": {
                            "x": 150,
                            "y": 100
                        },
                        "layer": 1,
                        "start": {
                            "x": 100,
                            "y": 100
                        }
                    },
                    {
                        "end": {
                            "x": 150,
                            "y": 150
                        },
                        "layer": 2,
                        "start": {
                            "x": 150,
                            "y": 100
                        }
                    }
                ],
                "vias": [
                    {
                        "x": 150,
                        "y": 100
                    }
                ]
            }
        ],
        "subModules": {}
    }
}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-export">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="download-json">ä¸‹è½½æ–‡ä»¶</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="import-modal">
        <div class="modal-content", style="width: 50%; height: 70%;">
            <div class="modal-header">å¯¼å…¥æ–‡ä»¶</div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="layout-route">å¸ƒå±€å’Œå¸ƒçº¿</div>
                </div>
            
                <div class="tab-content active" id="import-layout-route">
                    <div class="file-import">
                        <p>è¯·åŒæ—¶é€‰æ‹©å¸ƒå±€æ–‡ä»¶å’Œå¸ƒçº¿æ–‡ä»¶:</p>
                    
                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div style="flex: 1;">
                                <p>å¸ƒå±€æ–‡ä»¶ (Layout_after.json):</p>
                                <div class="file-input" id="layout-file-drop" data-file-type="layout">
                                    æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©
                                </div>
                                <input type="file" id="layout-file-input" accept=".json" style="display: none;">
                            </div>
                        
                            <div style="flex: 1;">
                                <p>å¸ƒçº¿æ–‡ä»¶ (Route_after.json):</p>
                                <div class="file-input" id="route-file-drop" data-file-type="route">
                                    æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©
                                </div>
                                <input type="file" id="route-file-input" accept=".json" style="display: none;">
                            </div>
                        </div>
                    
                        <div style="display: flex; gap: 20px;">
                            <div style="flex: 1;">
                                <p>å¸ƒå±€æ–‡ä»¶é¢„è§ˆ:</p>
                                <div class="json-preview" id="layout-import-preview" style="height: 200px;">
                                    æ–‡ä»¶å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                                </div>
                            </div>
                        
                            <div style="flex: 1;">
                                <p>å¸ƒçº¿æ–‡ä»¶é¢„è§ˆ:</p>
                                <div class="json-preview" id="route-import-preview" style="height: 200px;">
                                    æ–‡ä»¶å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-import">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="import-file">å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentMode = 'select'; // 'select' | 'wire' | 'delete'
        let currentLayer = 'metal1';
        let selectedComponent = null;
        let wireStartPin = null;
        let zoomLevel = 1.0;
        let components = [];
        let wires = [];
        let vias = [];
        let gridSize = 20;
        let tempWire = null;
        let currentExportType = 'vjson';
        let currentImportType = 'vjson';
        let importedLayoutJson = null;
        let importedRouteJson = null;
        let draggingComponent = null;
        let startX, startY, componentStartX, componentStartY;
        let connectedWires = [];
        let layerVisibility = {
            metal1: true,
            metal2: true,
            metal3: true,
            metal4: true,
            metal5: true
        };

        // ä»¿çœŸç›¸å…³å˜é‡
        let simulationMode = false;
        let simulationData = null;
        let inputValues = {};
        
        // æ·»åŠ ç”»å¸ƒå¹³ç§»åŠŸèƒ½å˜é‡
        let panX = 0;
        let panY = 0;
        let isDraggingCanvas = false;
        let lastClientX = 0;
        let lastClientY = 0;
        
        // DOM å…ƒç´ 
        const canvas = document.getElementById('circuit-canvas');
        const cursorPosition = document.getElementById('cursor-position');
        const zoomLevelElement = document.getElementById('zoom-level');
        const currentModeElement = document.getElementById('current-mode');
        const exportModal = document.getElementById('export-modal');
        const importModal = document.getElementById('import-modal');
        const currentLayerElement = document.getElementById('current-layer');
        const canvasContainer = document.querySelector('.canvas-container');
        const verilogTemplate = `module My_and(A, B, Y )
input A, B;
output Y;
    wire tmp;
    nmos(tmp, VCC, A);
    nmos(Y, tmp, B);
    pmos(Y, GND, A);
    pmos(Y, GND, B);
endmodule

module My_or(A, B, Y)
input A, B;
output Y;
    wire tmp;
    nmos(Y, VCC, A);
    nmos(Y, VCC, B);
    pmos(tmp, GND, A);
    pmos(Y, tmp, B);
endmodule

module My_xor(A, B, Y)
input A, B;
output Y;
    wire tmp1, tmp2, tmp3, tmp4;
    pmos(tmp1, GND, A);
    pmos(Y, tmp1, B);
    nmos(tmp2, GND, A);
    nmos(Y, tmp2, B);

    pmos(tmp3, VCC, A);
    nmos(Y, tmp3, B);
    nmos(tmp4, VCC, A);
    pmos(Y, tmp4, B);
endmodule

module adder(A, B, Cin, D, Cout)
input A, B, Cin;
output D, Cout;
    wire tmp_xor, tmp_and_1, tmp_and_2;
    My_xor f0(A, B, tmp_xor);
    My_xor f1(Cin, tmp_xor, D);
    My_and f2(A, B, tmp_and_1);
    My_and f3(tmp_xor, Cin, tmp_and_2);
    My_or f4(tmp_and_1, tmp_and_2, Cout);
endmodule`;
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('verilog-editor').value = verilogTemplate;
        });
        // æ–°å¢äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('verilog-btn').addEventListener('click', showVerilogModal);
        document.getElementById('close-verilog').addEventListener('click', hideVerilogModal);
        document.getElementById('save-verilog').addEventListener('click', saveVerilog);
        
        function showVerilogModal() {
            document.getElementById('verilog-modal').classList.add('active');
        }
        
        function hideVerilogModal() {
            document.getElementById('verilog-modal').classList.remove('active');
        }
        
        // è¿›å…¥ä»¿çœŸæ¨¡å¼
        document.getElementById('simulation-btn').addEventListener('click', function() {
            simulationMode = !simulationMode;
            const panel = document.querySelector('.simulation-panel');
            panel.style.display = simulationMode ? 'block' : 'none';
            
            if (simulationMode) {
                document.getElementById('simulation-btn').classList.add('active');
                loadSimulationData();
            } else {
                document.getElementById('simulation-btn').classList.remove('active');
            }
        });
        
        // åŠ è½½ä»¿çœŸæ•°æ®
        function loadSimulationData() {
            fetch('http://localhost:5000/get_simulation_data')
                .then(response => response.json())
                .then(data => {
                    simulationData = data;
                    setupSimulationControls();
                })
                .catch(error => {
                    console.error('è·å–ä»¿çœŸæ•°æ®å¤±è´¥:', error);
                    document.getElementById('simulation-description').textContent = 
                        'è·å–ä»¿çœŸæ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯å·²ç”Ÿæˆä»¿çœŸæ–‡ä»¶';
                });
        }
        
        // è®¾ç½®ä»¿çœŸæ§ä»¶
        function setupSimulationControls() {
            const inputControls = document.getElementById('input-controls');
            const outputDisplay = document.getElementById('output-display');
            
            inputControls.innerHTML = '';
            outputDisplay.innerHTML = '';
            
            // è®¾ç½®è¾“å…¥æ§ä»¶
            simulationData.input_ports.forEach(port => {
                const control = document.createElement('div');
                control.className = 'input-control';
                
                control.innerHTML = `
                    <div class="input-name">${port}</div>
                    <div class="input-toggle">
                        <div class="toggle-btn" data-port="${port}" data-value="0">0</div>
                        <div class="toggle-btn" data-port="${port}" data-value="1">1</div>
                    </div>
                `;
                
                inputControls.appendChild(control);
                
                // é»˜è®¤å€¼è®¾ä¸º0
                inputValues[port] = '0';
                
                // è®¾ç½®åˆ‡æ¢äº‹ä»¶
                control.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const value = this.dataset.value;
                        inputValues[port] = value;
                        
                        // æ›´æ–°æ´»åŠ¨çŠ¶æ€
                        this.parentElement.querySelectorAll('.toggle-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        this.classList.add('active');
                    });
                });
                
                // è®¾ç½®ç¬¬ä¸€ä¸ªä¸ºé»˜è®¤æ´»åŠ¨
                control.querySelector('.toggle-btn[data-value="0"]').classList.add('active');
            });
            
            // è®¾ç½®è¾“å‡ºæ˜¾ç¤º
            simulationData.output_ports.forEach(port => {
                const outputRow = document.createElement('div');
                outputRow.className = 'output-row';
                outputRow.innerHTML = `
                    <div>${port}</div>
                    <div class="output-value" id="output-${port}">?</div>
                `;
                outputDisplay.appendChild(outputRow);
            });
            
            // è®¾ç½®æè¿°
            document.getElementById('simulation-description').innerHTML = 
                `ä»¿çœŸæ¨¡å—: <strong>${simulationData.module_name}</strong><br>
                 è¾“å…¥ç«¯å£: ${simulationData.input_ports.join(', ')}<br>
                 è¾“å‡ºç«¯å£: ${simulationData.output_ports.join(', ')}`;
        }
        
        // è¿è¡Œä»¿çœŸ
        document.getElementById('run-simulation').addEventListener('click', function() {
            if (!simulationData) return;
            
            // æŸ¥æ‰¾åŒ¹é…çš„è¡Œ
            const inputValuesStr = simulationData.input_ports.map(p => inputValues[p]).join(' | ');
            const matchingRow = simulationData.table.find(row => {
                return simulationData.input_ports.every(port => 
                    row[port] === inputValues[port]
                );
            });
            
            if (!matchingRow) {
                alert('æœªæ‰¾åˆ°åŒ¹é…çš„è¾“å…¥ç»„åˆ');
                return;
            }
            
            // æ›´æ–°è¾“å‡ºæ˜¾ç¤º
            simulationData.output_ports.forEach(port => {
                document.getElementById(`output-${port}`).textContent = matchingRow[port];
            });
        });
        
        function saveVerilog() {
            const verilogCode = document.getElementById('verilog-editor').value;
            
            // å‘é€åˆ°åç«¯
            fetch('http://localhost:5000/upload_verilog', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ verilog: verilogCode }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                alert('Verilogæ–‡ä»¶å·²å‘é€å¤„ç†ï¼è¯·è€å¿ƒç­‰å¾…è§£æä¸å¸ƒå±€å®Œæˆ');
            })
            .catch((error) => {
                console.error('å‘é€å¤±è´¥:', error);
                alert('å¤„ç†Verilogæ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
            });
        }
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
        
        function init() {
            setupEventListeners();
            drawGrid();
            updateStats();
            updateLayerVisibility();
            setupFileDropEvents();
            applyTransform();
        }
        
        function setupFileDropEvents() {
            const layoutDrop = document.getElementById('layout-file-drop');
            const layoutInput = document.getElementById('layout-file-input');
            const routeDrop = document.getElementById('route-file-drop');
            const routeInput = document.getElementById('route-file-input');
            
            // å¸ƒå±€æ–‡ä»¶
            layoutDrop.addEventListener('click', () => layoutInput.click());
            layoutDrop.addEventListener('dragover', (e) => {
                e.preventDefault();
                layoutDrop.style.backgroundColor = 'rgba(255, 255, 255, 0.15)';
            });
            layoutDrop.addEventListener('dragleave', () => {
                layoutDrop.style.backgroundColor = '';
            });
            layoutDrop.addEventListener('drop', (e) => {
                e.preventDefault();
                layoutDrop.style.backgroundColor = '';
                if (e.dataTransfer.files.length) {
                    layoutInput.files = e.dataTransfer.files;
                    const event = new Event('change');
                    layoutInput.dispatchEvent(event);
                }
            });
            
            // å¸ƒçº¿æ–‡ä»¶
            routeDrop.addEventListener('click', () => routeInput.click());
            routeDrop.addEventListener('dragover', (e) => {
                e.preventDefault();
                routeDrop.style.backgroundColor = 'rgba(255, 255, 255, 0.15)';
            });
            routeDrop.addEventListener('dragleave', () => {
                routeDrop.style.backgroundColor = '';
            });
            routeDrop.addEventListener('drop', (e) => {
                e.preventDefault();
                routeDrop.style.backgroundColor = '';
                if (e.dataTransfer.files.length) {
                    routeInput.files = e.dataTransfer.files;
                    const event = new Event('change');
                    routeInput.dispatchEvent(event);
                }
            });
        }

        function setupEventListeners() {
            // æ¨¡å¼åˆ‡æ¢
            document.getElementById('select-mode-btn').addEventListener('click', () => setMode('select'));
            document.getElementById('delete-mode-btn').addEventListener('click', () => setMode('delete'));
            document.getElementById('wire-mode-btn').addEventListener('click', () => setMode('wire'));
            document.getElementById('show-all-layers').addEventListener('click', toggleAllLayers);
            
            // å…ƒä»¶é€‰æ‹©
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (currentMode === 'select') {
                        selectedComponent = item.dataset.type;
                        document.querySelectorAll('.component-item').forEach(i => i.style.border = '');
                        item.style.border = '2px solid var(--primary)';
                    }
                });
            });
            
            // å›¾å±‚é€‰æ‹©å’Œå¯è§æ€§åˆ‡æ¢
            document.querySelectorAll('.layer-option').forEach(option => {
                // å›¾å±‚é€‰æ‹©
                option.addEventListener('click', (e) => {
                    if (e.target.closest('.layer-visibility')) {
                        // ç‚¹å‡»çš„æ˜¯å¯è§æ€§å›¾æ ‡
                        const layer = option.dataset.layer;
                        layerVisibility[layer] = !layerVisibility[layer];
                        updateLayerVisibility();
                    } else {
                        // ç‚¹å‡»çš„æ˜¯å›¾å±‚é€‰é¡¹
                        document.querySelectorAll('.layer-option').forEach(o => o.classList.remove('active'));
                        option.classList.add('active');
                        currentLayer = option.dataset.layer;
                        currentLayerElement.textContent = currentLayer;
                    }
                });
            });
            
            // ç¼©æ”¾æ§åˆ¶
            document.getElementById('zoom-in').addEventListener('click', () => zoom(1.2));
            document.getElementById('zoom-out').addEventListener('click', () => zoom(0.8));
            document.getElementById('zoom-reset').addEventListener('click', () => zoom(1.0, true));
            
            // ç”»å¸ƒäº¤äº’
            canvasContainer.addEventListener('mousedown', handleCanvasMousedown);
            canvasContainer.addEventListener('mousemove', handleCanvasMousemove);
            canvasContainer.addEventListener('mouseup', handleCanvasMouseup);
            canvasContainer.addEventListener('mouseleave', handleCanvasMouseup);
            canvasContainer.addEventListener('click', handleCanvasClick);
            canvasContainer.addEventListener('mousemove', handleCanvasMouseMove);
            
            // å¯¼å‡ºåŠŸèƒ½
            document.getElementById('export-btn').addEventListener('click', showExportModal);
            document.getElementById('close-export').addEventListener('click', hideExportModal);
            document.getElementById('download-json').addEventListener('click', downloadJson);
            
            // å¯¼å…¥åŠŸèƒ½
            document.getElementById('import-btn').addEventListener('click', showImportModal);
            document.getElementById('close-import').addEventListener('click', hideImportModal);
            document.getElementById('import-file').addEventListener('click', importFile);
            
            // å¯¼å‡ºæ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('#export-modal .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    document.querySelectorAll('#export-modal .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('#export-modal .tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    currentExportType = tabId;
                });
            });
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
            document.getElementById('layout-file-input').addEventListener('change', (e) => {
                handleFileSelect(e, 'layout-import-preview', true);
            });
            document.getElementById('route-file-input').addEventListener('change', (e) => {
                handleFileSelect(e, 'route-import-preview', false);
            });
            
            // æ·»åŠ é¼ æ ‡æ»šè½®ç¼©æ”¾
            canvasContainer.addEventListener('wheel', handleWheel, { passive: false });
        }
        
        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.8 : 1.2;
            zoom(delta, false, e.clientX, e.clientY);
        }
        
        function setMode(mode) {
            currentMode = mode;
            currentModeElement.textContent = 
                mode === 'select' ? 'é€‰æ‹©æ¨¡å¼' : 
                mode === 'wire' ? 'è¿çº¿æ¨¡å¼' : 
                'åˆ é™¤æ¨¡å¼';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('select-mode-btn').classList.toggle('active', mode === 'select');
            document.getElementById('wire-mode-btn').classList.toggle('active', mode === 'wire');
            document.getElementById('delete-mode-btn').classList.toggle('active', mode === 'delete');
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            if (mode === 'wire') {
                selectedComponent = null;
                document.querySelectorAll('.component-item').forEach(i => i.style.border = '');
            }
        }
        
        function drawGrid() {
            // ç½‘æ ¼èƒŒæ™¯ç”±CSSå¤„ç†
        }
        
        function handleCanvasMouseMove(e) {
            const {x, y} = getCanvasCoords(e.clientX, e.clientY);
            const gridX = Math.floor(x / gridSize) * gridSize;
            const gridY = Math.floor(y / gridSize) * gridSize;
            cursorPosition.textContent = `(${gridX}, ${gridY})`;
        }
        
        function handleCanvasMousedown(e) {
            // å¤„ç†ç”»å¸ƒæ‹–åŠ¨
            if (e.button === 1 || (e.button === 0 && e.shiftKey)) { // ä¸­é”®æˆ–Shift+å·¦é”®
                isDraggingCanvas = true;
                lastClientX = e.clientX;
                lastClientY = e.clientY;
                canvasContainer.classList.add('dragging');
                return;
            }
            
            if (currentMode === 'select') {
                const element = e.target.closest('[data-id]');
                if (element) {
                    draggingComponent = components.find(c => c.id === element.dataset.id);
                    if (draggingComponent) {
                        const {x, y} = getCanvasCoords(e.clientX, e.clientY);
                        startX = x;
                        startY = y;
                        componentStartX = draggingComponent.x;
                        componentStartY = draggingComponent.y;
                        
                        // ä¿å­˜ä¸å½“å‰å…ƒä»¶ç›¸è¿çš„è¿çº¿
                        connectedWires = wires.filter(wire => 
                            wire.start.parent === draggingComponent.id || wire.end.parent === draggingComponent.id
                        );
                    }
                }
            }
        }

        function handleCanvasMousemove(e) {
            if (isDraggingCanvas) {
                const dx = e.clientX - lastClientX;
                const dy = e.clientY - lastClientY;
                lastClientX = e.clientX;
                lastClientY = e.clientY;
                panX += dx;
                panY += dy;
                applyTransform();
                return;
            }
            
            if (draggingComponent) {
                const {x, y} = getCanvasCoords(e.clientX, e.clientY);
                const deltaX = x - startX;
                const deltaY = y - startY;
                
                // å¯¹é½åˆ°ç½‘æ ¼
                draggingComponent.x = Math.round((componentStartX + deltaX) / gridSize) * gridSize;
                draggingComponent.y = Math.round((componentStartY + deltaY) / gridSize) * gridSize;
                
                // æ›´æ–°å¼•è„šä½ç½®
                updatePinPositions(draggingComponent);
                
                // æ¸…ç†æ—§æ¸²æŸ“
                document.querySelectorAll(`[data-id='${draggingComponent.id}']`).forEach(el => el.remove());
                document.querySelectorAll(`.component-label[data-parent='${draggingComponent.id}']`).forEach(el => el.remove());
                document.querySelectorAll(`.pin[data-parent='${draggingComponent.id}']`).forEach(el => el.remove());
                
                // é‡æ–°æ¸²æŸ“å…ƒä»¶
                renderComponent(draggingComponent);
                
                // æ›´æ–°è¿çº¿çš„ä½ç½®
                updateConnectedWires();
                
            } else if (wireStartPin) {
                // ç»˜åˆ¶ä¸´æ—¶è¿æ¥çº¿
                const {x, y} = getCanvasCoords(e.clientX, e.clientY);
                const gridX = Math.floor(x / gridSize) * gridSize;
                const gridY = Math.floor(y / gridSize) * gridSize;
                
                // æ¸…é™¤ä¹‹å‰çš„ä¸´æ—¶çº¿
                if (tempWire) {
                    tempWire.remove();
                }
                
                // ç»˜åˆ¶ä»èµ·ç‚¹åˆ°å½“å‰é¼ æ ‡ä½ç½®çš„æ–°çº¿
                const ns = "http://www.w3.org/2000/svg";
                tempWire = document.createElementNS(ns, 'line');
                tempWire.setAttribute('x1', wireStartPin.x);
                tempWire.setAttribute('y1', wireStartPin.y);
                tempWire.setAttribute('x2', gridX);
                tempWire.setAttribute('y2', gridY);
                tempWire.setAttribute('class', 'connection-indicator');
                canvas.appendChild(tempWire);
            }
        }
        
        // æ›´æ–°ä¸å½“å‰å…ƒä»¶ç›¸è¿çš„è¿çº¿
        function updateConnectedWires() {
            if (!draggingComponent) return;
            
            connectedWires.forEach(wire => {
                // åˆ é™¤æ—§çš„è¿çº¿SVGå…ƒç´ 
                document.querySelectorAll(`[data-wire-id='${wire.id}']`).forEach(el => el.remove());
                
                // æ›´æ–°è¿çº¿çš„èµ·ç‚¹æˆ–ç»ˆç‚¹ä½ç½®ï¼ˆå¦‚æœå®ƒä»¬å±äºè¢«ç§»åŠ¨çš„å…ƒä»¶ï¼‰
                if (wire.start.parent === draggingComponent.id) {
                    const pin = draggingComponent.pins.find(p => p.id === wire.start.id);
                    if (pin) {
                        wire.start.x = pin.x;
                        wire.start.y = pin.y;
                    }
                }
                if (wire.end.parent === draggingComponent.id) {
                    const pin = draggingComponent.pins.find(p => p.id === wire.end.id);
                    if (pin) {
                        wire.end.x = pin.x;
                        wire.end.y = pin.y;
                    }
                }
                
                // é‡æ–°è®¡ç®—çº¿æ®µå’Œè¿‡å­”
                wire.segments = [
                    { 
                        start: {x: wire.start.x, y: wire.start.y}, 
                        end: {x: wire.end.x, y: wire.start.y},
                        layer: 'metal1' // æ°´å¹³çº¿æ®µåœ¨metal1å±‚
                    },
                    { 
                        start: {x: wire.end.x, y: wire.start.y}, 
                        end: {x: wire.end.x, y: wire.end.y},
                        layer: 'metal2' // å‚ç›´çº¿æ®µåœ¨metal2å±‚
                    }
                ];
                wire.vias = [{x: wire.end.x, y: wire.start.y}];
                
                // é‡æ–°æ¸²æŸ“è¿™æ¡è¿çº¿
                renderWire(wire);
            });
        }

        function handleCanvasMouseup(e) {
            isDraggingCanvas = false;
            canvasContainer.classList.remove('dragging');
            
            if (draggingComponent) {
                // æ›´æ–°è¿çº¿çš„ä½ç½®
                updateConnectedWires();
                
                draggingComponent = null;
            }
            
            // ç§»é™¤ä¸´æ—¶è¿æ¥çº¿
            if (tempWire) {
                tempWire.remove();
                tempWire = null;
            }
        }

        function handleCanvasClick(e) {
            const {x, y} = getCanvasCoords(e.clientX, e.clientY);
            const gridX = Math.floor(x / gridSize) * gridSize;
            const gridY = Math.floor(y / gridSize) * gridSize;
            
            // åˆ é™¤æ¨¡å¼
            if (currentMode === 'delete') {
                const element = e.target.closest('[data-id], [data-parent], [data-wire-id], [data-segment-id], [data-via-id]');
                
                if (!element) return;
                
                // åˆ é™¤æ•´ä¸ªå¸ƒçº¿ç½‘ç»œ
                if (element.hasAttribute('data-wire-id')) {
                    const wireId = element.dataset.wireId;
                    const wire = wires.find(w => w.id === wireId);
                    
                    if (wire) {
                        // åˆ é™¤æ‰€æœ‰ç›¸å…³SVGå…ƒç´ 
                        document.querySelectorAll(`[data-wire-id='${wireId}']`).forEach(el => el.remove());
                        
                        // ä»æ•°ç»„ä¸­ç§»é™¤
                        wires = wires.filter(w => w.id !== wireId);
                        updateStats();
                    }
                    return;
                }
                
                // åˆ é™¤å•ä¸ªçº¿æ®µ
                if (element.hasAttribute('data-segment-id')) {
                    const segmentId = element.dataset.segmentId;
                    const wireId = element.dataset.wireId;
                    
                    // ä»DOMä¸­ç§»é™¤
                    element.remove();
                    
                    // ä»æ•°æ®ç»“æ„ä¸­ç§»é™¤
                    const wire = wires.find(w => w.id === wireId);
                    if (wire) {
                        wire.segments = wire.segments.filter(seg => seg.id !== segmentId);
                        updateStats();
                    }
                    return;
                }
                
                // åˆ é™¤å•ä¸ªè¿‡å­”
                if (element.hasAttribute('data-via-id')) {
                    const viaId = element.dataset.viaId;
                    const wireId = element.dataset.wireId;
                    
                    // ä»DOMä¸­ç§»é™¤
                    element.remove();
                    
                    // ä»æ•°æ®ç»“æ„ä¸­ç§»é™¤
                    const wire = wires.find(w => w.id === wireId);
                    if (wire) {
                        wire.vias = wire.vias.filter(v => v.id !== viaId);
                        updateStats();
                    }
                    return;
                }
                
                // åˆ é™¤å…ƒä»¶
                const componentId = element.dataset.id || element.dataset.parent;
                const component = components.find(c => c.id === componentId);
                
                if (component) {
                    // åˆ é™¤è¿æ¥åˆ°è¯¥å…ƒä»¶çš„æ‰€æœ‰è¿çº¿
                    wires.forEach(wire => {
                        if (wire.start.parent === componentId || wire.end.parent === componentId) {
                            document.querySelectorAll(`[data-wire-id='${wire.id}']`).forEach(el => el.remove());
                        }
                    });
                    wires = wires.filter(wire => !(wire.start.parent === componentId || wire.end.parent === componentId));
                    
                    // åˆ é™¤å…ƒä»¶
                    components = components.filter(c => c.id !== componentId);
                    document.querySelectorAll(`[data-id='${componentId}'], [data-parent='${componentId}'], .component-label[data-parent='${componentId}']`).forEach(el => el.remove());
                    updateStats();
                }
                return;
            }
            
            // é€‰æ‹©æ¨¡å¼ - æ”¾ç½®å…ƒä»¶
            if (currentMode === 'select' && selectedComponent) {
                placeComponent(selectedComponent, gridX, gridY);
                return;
            }
            
            // è¿çº¿æ¨¡å¼
            if (currentMode === 'wire') {
                // æŸ¥æ‰¾ç‚¹å‡»çš„å¼•è„š
                const pin = findPinAt(gridX, gridY);
                
                if (pin) {
                    if (wireStartPin) {
                        // ç¡®ä¿ä¸æ˜¯åŒä¸€ä¸ªå¼•è„š
                        if (wireStartPin.id !== pin.id) {
                            createWire(wireStartPin, pin);
                        }
                        wireStartPin = null;
                        
                        // ç§»é™¤ä¸´æ—¶çº¿
                        if (tempWire) {
                            tempWire.remove();
                            tempWire = null;
                        }
                    } else {
                        wireStartPin = pin;
                    }
                }
            }
        }

        function findPinAt(x, y) {
            const tolerance = 10; // ç‚¹å‡»å®¹å·®èŒƒå›´
            for (const comp of components) {
                for (const pin of comp.pins) {
                    const dx = Math.abs(pin.x - x);
                    const dy = Math.abs(pin.y - y);
                    if (dx < tolerance && dy < tolerance) {
                        return {
                            id: pin.id,
                            x: pin.x,
                            y: pin.y,
                            parent: comp.id,
                            type: pin.type
                        };
                    }
                }
            }
            return null;
        }
        
        // åœ¨ç”»å¸ƒä¸Šæ”¾ç½®å…ƒä»¶
        function placeComponent(type, x, y, name = null) {
            const id = `comp_${Date.now()}`;
            const component = { 
                id, 
                type, 
                x, 
                y, 
                pins: [],
                name: name || `${type}_${components.length + 1}`
            };
            
            // æ ¹æ®å…ƒä»¶ç±»å‹åˆ›å»ºå¼•è„š
            switch(type) {
                case 'nmos':
                case 'pmos':
                    component.pins = [
                        { id: `${id}_source`, type: 'source', offsetX: gridSize, offsetY: gridSize*2 },
                        { id: `${id}_gate`, type: 'gate', offsetX: gridSize*3, offsetY: gridSize*3 },
                        { id: `${id}_drain`, type: 'drain', offsetX: gridSize*5, offsetY: gridSize*2 }
                    ];
                    break;
                case 'input':
                case 'output':
                case 'vcc':
                case 'gnd':
                    component.pins = [
                        { id: `${id}_main`, type: 'main', offsetX: 0, offsetY: 0 }
                    ];
                    break;
            }
            
            // æ›´æ–°å¼•è„šä½ç½®
            updatePinPositions(component);
            
            components.push(component);
            renderComponent(component);
            updateStats();
        }

        // æ›´æ–°å…ƒä»¶å¼•è„šä½ç½®
        function updatePinPositions(component) {
            component.pins.forEach(pin => {
                pin.x = component.x + pin.offsetX;
                pin.y = component.y + pin.offsetY;
            });
        }

        // åˆ›å»ºæ–°çš„è¿çº¿
        function createWire(startPin, endPin) {
            const wireId = `wire_${Date.now()}`;
            
            const wire = {
                id: wireId,
                start: startPin,
                end: endPin,
                segments: [],
                vias: []
            };
            
            // åˆ›å»ºæ°´å¹³çº¿æ®µ
            const horizontalSegment = {
                id: `${wireId}_seg1`,
                start: {x: startPin.x, y: startPin.y},
                end: {x: endPin.x, y: startPin.y},
                layer: 'metal1'
            };
            
            // åˆ›å»ºå‚ç›´çº¿æ®µ
            const verticalSegment = {
                id: `${wireId}_seg2`,
                start: {x: endPin.x, y: startPin.y},
                end: {x: endPin.x, y: endPin.y},
                layer: 'metal2'
            };
            
            // åˆ›å»ºè¿‡å­”
            const via = {
                id: `${wireId}_via1`,
                x: endPin.x,
                y: startPin.y
            };
            
            wire.segments.push(horizontalSegment, verticalSegment);
            wire.vias.push(via);
            
            wires.push(wire);
            renderWire(wire);
            updateStats();
        }

        // æ¸²æŸ“å®Œæ•´çš„å¸ƒçº¿
        function renderWire(wire) {
            const ns = "http://www.w3.org/2000/svg";
            
            // æ¸²æŸ“æ‰€æœ‰çº¿æ®µ
            wire.segments.forEach(segment => {
                const line = document.createElementNS(ns, 'line');
                line.setAttribute('x1', segment.start.x);
                line.setAttribute('y1', segment.start.y);
                line.setAttribute('x2', segment.end.x);
                line.setAttribute('y2', segment.end.y);
                line.setAttribute('class', `wire fixed-wire ${segment.layer}`);
                line.setAttribute('data-wire-id', wire.id);
                line.setAttribute('data-segment-id', segment.id);
                canvas.appendChild(line);
            });
            
            // æ¸²æŸ“æ‰€æœ‰è¿‡å­”
            wire.vias.forEach(via => {
                const viaElement = document.createElementNS(ns, 'rect');
                viaElement.setAttribute('x', via.x - 1.5);
                viaElement.setAttribute('y', via.y - 1.5);
                viaElement.setAttribute('width', 3);
                viaElement.setAttribute('height', 3);
                viaElement.setAttribute('class', 'fixed-via');
                viaElement.setAttribute('fill', '#FF5722');
                viaElement.setAttribute('data-wire-id', wire.id);
                viaElement.setAttribute('data-via-id', via.id);
                canvas.appendChild(viaElement);
            });
        }

        function updatePinPositions(component) {
            component.pins.forEach(pin => {
                pin.x = component.x + pin.offsetX;
                pin.y = component.y + pin.offsetY;
            });
        }
        
        function renderComponent(component) {
            const ns = "http://www.w3.org/2000/svg";
            let element;
            
            switch(component.type) {
                case 'nmos':
                    element = document.createElementNS(ns, 'path');
                    // ç»˜åˆ¶NMOSæ™¶ä½“ç®¡ (6x4 ç½‘æ ¼å•ä½)
                    const nmosPath = `M ${component.x},${component.y} 
                                     L ${component.x + gridSize*6},${component.y} 
                                     L ${component.x + gridSize*6},${component.y + gridSize*4} 
                                     L ${component.x},${component.y + gridSize*4} 
                                     L ${component.x},${component.y} 
                                     M ${component.x + gridSize*3},${component.y + gridSize*3} 
                                     L ${component.x + gridSize*3},${component.y + gridSize*4}`;
                    element.setAttribute('d', nmosPath);
                    element.setAttribute('class', `transistor nmos`);
                    break;
                case 'pmos':
                    element = document.createElementNS(ns, 'path');
                    // ç»˜åˆ¶PMOSæ™¶ä½“ç®¡ (6x4 ç½‘æ ¼å•ä½)
                    const pmosPath = `M ${component.x},${component.y} 
                                     L ${component.x + gridSize*6},${component.y} 
                                     L ${component.x + gridSize*6},${component.y + gridSize*4} 
                                     L ${component.x},${component.y + gridSize*4} 
                                     L ${component.x},${component.y}
                                     M ${component.x + gridSize*3},${component.y + gridSize*3} 
                                     L ${component.x + gridSize*3},${component.y + gridSize*4}`;
                    element.setAttribute('d', pmosPath);
                    element.setAttribute('class', `transistor pmos`);
                    break;
                case 'input':
                case 'output':
                case 'vcc':
                case 'gnd':
                    element = document.createElementNS(ns, 'circle');
                    element.setAttribute('cx', component.x);
                    element.setAttribute('cy', component.y);
                    element.setAttribute('r', 15);
                    element.setAttribute('class', `port ${component.type}`);
                    break;
            }
            
            if (element) {
                element.setAttribute('data-id', component.id);
                canvas.appendChild(element);
                
                // æ·»åŠ æ ‡ç­¾
                const label = document.createElementNS(ns, 'text');
                label.setAttribute('x', component.x);
                label.setAttribute('y', component.type === 'nmos' || component.type === 'pmos' ? component.y + gridSize*5 : component.y + 25);
                label.setAttribute('class', 'component-label');
                label.setAttribute('data-parent', component.id);
                label.textContent = component.name;
                canvas.appendChild(label);
                
                // æ¸²æŸ“å¼•è„š
                component.pins.forEach(pin => {
                    const pinElement = document.createElementNS(ns, 'circle');
                    pinElement.setAttribute('cx', pin.x);
                    pinElement.setAttribute('cy', pin.y);
                    pinElement.setAttribute('r', 5);
                    pinElement.setAttribute('class', 'pin');
                    pinElement.setAttribute('data-pin-type', pin.type);
                    pinElement.setAttribute('data-parent', component.id);
                    pinElement.setAttribute('data-pin-id', pin.id);
                    canvas.appendChild(pinElement);
                });
            }
        }
        
        function createWire(startPin, endPin) {
            const wireId = `wire_${Date.now()}`;
            
            // ç¡®å®šæ°´å¹³çº¿æ®µå’Œå‚ç›´çº¿æ®µçš„å±‚
            const horizontalLayer = 'metal1';
            const verticalLayer = 'metal2';
            
            const wire = {
                id: wireId,
                start: startPin,
                end: endPin,
                segments: [
                    { 
                        start: {x: startPin.x, y: startPin.y}, 
                        end: {x: endPin.x, y: startPin.y},
                        layer: horizontalLayer
                    },
                    { 
                        start: {x: endPin.x, y: startPin.y}, 
                        end: {x: endPin.x, y: endPin.y},
                        layer: verticalLayer
                    }
                ],
                vias: [{x: endPin.x, y: startPin.y}]
            };
            
            wires.push(wire);
            renderWire(wire);
            updateStats();
        }
        
        function renderWire(wire) {
            const ns = "http://www.w3.org/2000/svg";
            
            // ç»˜åˆ¶çº¿æ®µ
            wire.segments.forEach(segment => {
                // æ£€æŸ¥å½“å‰å±‚æ˜¯å¦å¯è§
                if (!layerVisibility[segment.layer]) return;
                
                const line = document.createElementNS(ns, 'line');
                line.setAttribute('x1', segment.start.x);
                line.setAttribute('y1', segment.start.y);
                line.setAttribute('x2', segment.end.x);
                line.setAttribute('y2', segment.end.y);
                line.setAttribute('class', `wire fixed-wire ${segment.layer}`);
                line.setAttribute('data-wire-id', wire.id);
                canvas.appendChild(line);
            });
            
            // ç»˜åˆ¶è¿‡å­”
            wire.vias.forEach(via => {
                const viaElement = document.createElementNS(ns, 'circle');
                viaElement.setAttribute('cx', via.x);
                viaElement.setAttribute('cy', via.y);
                viaElement.setAttribute('r', 3);
                viaElement.setAttribute('class', 'via');
                viaElement.setAttribute('data-wire-id', wire.id);
                canvas.appendChild(viaElement);
            });
        }
        
        function zoom(factor, reset = false, clientX, clientY) {
            if (reset) {
                zoomLevel = 1.0;
                panX = 0;
                panY = 0;
            } else {
                const oldZoom = zoomLevel;
                zoomLevel *= factor;
                zoomLevel = Math.max(0.2, Math.min(zoomLevel, 5.0));
                
                if (clientX && clientY) {
                    const containerRect = canvasContainer.getBoundingClientRect();
                    const x = clientX - containerRect.left;
                    const y = clientY - containerRect.top;
                    
                    // è®¡ç®—ç¼©æ”¾ä¸­å¿ƒç›¸å¯¹äºç”»å¸ƒçš„ä½ç½®
                    const canvasX = (x - panX) / oldZoom;
                    const canvasY = (y - panY) / oldZoom;
                    
                    // è°ƒæ•´å¹³ç§»é‡ä»¥ä¿æŒç¼©æ”¾ä¸­å¿ƒä¸å˜
                    panX = x - canvasX * zoomLevel;
                    panY = y - canvasY * zoomLevel;
                }
            }
            
            zoomLevelElement.textContent = `${Math.round(zoomLevel * 100)}%`;
            applyTransform();
        }
        
        function applyTransform() {
            canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomLevel})`;
            canvas.style.transformOrigin = '0 0';
        }
        
        function getCanvasCoords(clientX, clientY) {
            const rect = canvasContainer.getBoundingClientRect();
            const x = (clientX - rect.left - panX) / zoomLevel;
            const y = (clientY - rect.top - panY) / zoomLevel;
            return {x, y};
        }
        
        function updateStats() {
            const transistors = components.filter(c => c.type === 'nmos' || c.type === 'pmos').length;
            const ports = components.filter(c => 
                c.type === 'input' || c.type === 'output' || c.type === 'vcc' || c.type === 'gnd'
            ).length;
            
            document.getElementById('transistor-count').textContent = transistors;
            document.getElementById('port-count').textContent = ports;
            document.getElementById('connection-count').textContent = wires.length;
        }
        
        function updateLayerVisibility() {
            // æ›´æ–°æ‰€æœ‰è¿çº¿çš„å¯è§æ€§
            document.querySelectorAll('.wire').forEach(wire => {
                const layer = Array.from(wire.classList).find(cls => 
                    ['metal1', 'metal2', 'metal3', 'metal4', 'metal5'].includes(cls));
                if (layer) {
                    wire.style.display = layerVisibility[layer] ? '' : 'none';
                }
            });
            
            // æ›´æ–°å›¾å±‚æ§åˆ¶ä¸­çš„å¯è§æ€§å›¾æ ‡
            document.querySelectorAll('.layer-option').forEach(option => {
                const layer = option.dataset.layer;
                const visibilityIcon = option.querySelector('.layer-visibility');
                if (visibilityIcon) {
                    visibilityIcon.innerHTML = layerVisibility[layer] ? 
                        '<path d="M12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5zM3.18 12c1.46 3.36 4.72 5.5 8.82 5.5s7.36-2.14 8.82-5.5C19.36 8.64 16.1 6.5 12 6.5S4.64 8.64 3.18 12z"/>' : 
                        '<path d="M12 6.5c2.76 0 5 2.24 5 5 0 .51-.1 1-.24 1.46l3.06 3.06c1.39-1.23 2.49-2.77 3.18-4.53C21.27 7.11 17 4 12 4c-1.27 0-2.49.2-3.64.57l2.17 2.17c.47-.14.96-.24 1.47-.24zM2.71 3.16a.996.996 0 0 0 0 1.41l1.97 1.97A11.892 11.892 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5 1.52 0 2.97-.3 4.31-.82l2.72 2.72a.996.996 0 1 0 1.41-1.41L4.13 3.16c-.39-.39-1.03-.39-1.42 0zM12 15.5c-2.76 0-5-2.24-5-5 0-.77.18-1.5.49-2.14l1.57 1.57c-.03.18-.06.37-.06.57 0 1.66 1.34 3 3 3 .2 0 .38-.03.57-.07L14.14 15c-.64.32-1.37.5-2.14.5zm2.97-5.33a2.97 2.97 0 0 0-2.64-2.64l2.64 2.64z"/>';
                }
            });
        }
        
        function toggleAllLayers() {
            const allVisible = Object.values(layerVisibility).every(v => v);
            Object.keys(layerVisibility).forEach(layer => {
                layerVisibility[layer] = !allVisible;
            });
            updateLayerVisibility();
        }
        
        function showExportModal() {
            // ç”Ÿæˆç”µè·¯æ•°æ®å¹¶å‘é€åˆ°æœ¬åœ°æœåŠ¡
            const circuitData = generateCircuitJson();
            
            // ä»…å‘é€è¿æ¥æè¿°æ•°æ®åˆ°æœ¬åœ°æœåŠ¡app.py
            fetch('http://localhost:5000/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    circuit: circuitData
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                alert('å¸ƒå±€æ•°æ®å·²æˆåŠŸå‘é€åˆ°æœ¬åœ°æœåŠ¡ï¼è¯·è€å¿ƒç­‰å¾…å¸ƒå±€å¸ƒçº¿å®Œæˆ');
            })
            .catch((error) => {
                console.error('å‘é€å¤±è´¥:', error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·ç¡®ä¿æœ¬åœ°æœåŠ¡app.pyå·²å¯åŠ¨å¹¶è¿è¡Œåœ¨http://localhost:5000');
            });
        }
        
        function hideExportModal() {
            exportModal.classList.remove('active');
        }
        
        function showImportModal() {
            importModal.classList.add('active');
        }
        
        function hideImportModal() {
            importModal.classList.remove('active');
        }
        
        function handleFileSelect(e, previewId, isLayoutFile) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonContent = JSON.parse(e.target.result);
                    document.getElementById(previewId).textContent = 
                        JSON.stringify(jsonContent, null, 2);
                    // å­˜å‚¨è§£æåçš„JSONå¯¹è±¡
                    if (isLayoutFile) {
                        importedLayoutJson = jsonContent;
                    } else {
                        importedRouteJson = jsonContent;
                    }
                } catch (error) {
                    document.getElementById(previewId).textContent = 
                        'é”™è¯¯: æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡® - ' + error.message;
                    // æ¸…é™¤é”™è¯¯çš„JSONå¯¹è±¡
                    if (isLayoutFile) {
                        importedLayoutJson = null;
                    } else {
                        importedRouteJson = null;
                    }
                }
            };
            reader.readAsText(file);
        }
        
        function parseLayout(moduleData) {
            // å¤„ç†ç«¯å£
            if (moduleData.ports) {
                for (const portName in moduleData.ports) {
                    const portData = moduleData.ports[portName];
                    const portLayout = portData.layout || {};
                    let type = portData.type;
                    
                    if (type === 'power') {
                        type = (portName.toLowerCase().includes('vdd') || portName === 'VCC') ? 'vcc' : 'gnd';
                    }
                    
                    placeComponent(type, 20 * portLayout.x, 20 * portLayout.y, portName);
                }
            }
            
            // å¤„ç†æ™¶ä½“ç®¡
            if (moduleData.mosfets) {
                for (const mosName in moduleData.mosfets) {
                    const mosData = moduleData.mosfets[mosName];
                    const mosLayout = mosData.layout || {};
                    placeComponent(mosData.type, 20 * mosLayout.x, 20 * mosLayout.y, mosName);
                }
            }
            
            // é€’å½’å¤„ç†å­æ¨¡å—
            if (moduleData.subModules) {
                for (const subName in moduleData.subModules) {
                    parseLayout(moduleData.subModules[subName]);
                }
            }
        }

        function addWire(netName, segments, vias) {
            const wireId = `wire_${Date.now()}`;
            const wire = {
                id: wireId,
                netName,
                segments: segments,
                vias: vias
            };

            // å°†æ•´ä¸ªå¸ƒçº¿ç½‘ç»œå­˜å‚¨èµ·æ¥
            wires.push(wire);

            // æ¸²æŸ“æ‰€æœ‰çº¿æ®µ
            segments.forEach(segment => {
                renderSegment(segment, wireId);
            });

            // æ¸²æŸ“æ‰€æœ‰è¿‡å­”
            vias.forEach(via => {
                renderVia(via, wireId);
            });

            updateStats();
        }

        function renderSegment(segment, wireId) {
            const ns = "http://www.w3.org/2000/svg";
            const line = document.createElementNS(ns, 'line');

            // è®¾ç½®çº¿æ®µå±æ€§
            line.setAttribute('x1', segment.start.x);
            line.setAttribute('y1', segment.start.y);
            line.setAttribute('x2', segment.end.x);
            line.setAttribute('y2', segment.end.y);
            line.setAttribute('class', `fixed-wire ${segment.layer}`);
            line.setAttribute('stroke-width', 2);
            line.setAttribute('data-wire-id', wireId);
            line.setAttribute('data-segment-id', segment.id || `seg_${Date.now()}`);

            // æ·»åŠ åˆ°ç”»å¸ƒ
            canvas.appendChild(line);
        }

        function renderVia(via, wireId) {
            const ns = "http://www.w3.org/2000/svg";
            const viaElement = document.createElementNS(ns, 'rect');

            // è®¾ç½®è¿‡å­”å±æ€§ï¼ˆ3x3åƒç´ ï¼‰
            viaElement.setAttribute('x', via.x - 1.5);
            viaElement.setAttribute('y', via.y - 1.5);
            viaElement.setAttribute('width', 3);
            viaElement.setAttribute('height', 3);
            viaElement.setAttribute('class', 'fixed-via');
            viaElement.setAttribute('fill', '#FF5722');
            viaElement.setAttribute('data-wire-id', wireId);
            viaElement.setAttribute('data-via-id', via.id || `via_${Date.now()}`);

            // æ·»åŠ åˆ°ç”»å¸ƒ
            canvas.appendChild(viaElement);
        }

        function parseRoute(routeData) {
            if (routeData.nets) {
                routeData.nets.forEach(net => {
                    const segments = [];
                    const vias = [];

                    // è§£æçº¿æ®µ
                    net.segments.forEach((seg, index) => {
                        const startPx = gridToPixels(seg.start);
                        const endPx = gridToPixels(seg.end);

                        segments.push({
                            id: `seg_${net.name}_${index}`,
                            start: { x: startPx.x, y: startPx.y },
                            end: { x: endPx.x, y: endPx.y },
                            layer: `metal${seg.layer}`
                        });
                    });

                    // è§£æè¿‡å­”
                    net.vias.forEach((via, index) => {
                        const viaPx = gridToPixels(via);
                        vias.push({
                            id: `via_${net.name}_${index}`,
                            x: viaPx.x,
                            y: viaPx.y
                        });
                    });

                    // æ·»åŠ å®Œæ•´çš„å¸ƒçº¿ç½‘ç»œ
                    addWire(net.name, segments, vias);
                });
            }

            // é€’å½’å¤„ç†å­æ¨¡å—
            if (routeData.subModules) {
                for (const subName in routeData.subModules) {
                    parseRoute(routeData.subModules[subName]);
                }
            }
        }
        
        function importFile() {
            if (!importedLayoutJson || !importedRouteJson) {
                alert('è¯·é€‰æ‹©å¸ƒå±€æ–‡ä»¶å’Œå¸ƒçº¿æ–‡ä»¶ï¼');
                return;
            }
            
            // æ¸…é™¤ç”»å¸ƒ
            clearCanvas();
            
            // è·å–é¡¶å±‚æ¨¡å—
            const layoutTop = getTopModule(importedLayoutJson);
            const routeTop = getTopModule(importedRouteJson);
            
            // è§£æå¸ƒå±€æ–‡ä»¶
            parseLayout(layoutTop);
            
            // è§£æå¸ƒçº¿æ–‡ä»¶
            parseRoute(routeTop);
            
            // è®¡ç®—å…ƒä»¶ä¸­å¿ƒå¹¶å±…ä¸­æ˜¾ç¤º
            centerComponents();
            
            // éšè—å¯¼å…¥æ¨¡æ€æ¡†
            hideImportModal();
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–é¡¶å±‚æ¨¡å—
        function getTopModule(json) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å•ä¸ªé¡¶å±‚æ¨¡å—
            if (typeof json === 'object' && !Array.isArray(json)) {
                const keys = Object.keys(json);
                if (keys.length === 1) {
                    return json[keys[0]];
                }
            }
            return json; // å·²ç»æ˜¯æ‰€éœ€æ ¼å¼
        }

        // ä¿®æ­£çš„æ¸²æŸ“å›ºå®šå¸ƒçº¿å‡½æ•°
        function renderFixedWire(wire) {
            const ns = "http://www.w3.org/2000/svg";
        
            // ç»˜åˆ¶çº¿æ®µ
            wire.segments.forEach(segment => {
                const line = document.createElementNS(ns, 'line');
                line.setAttribute('x1', segment.start.x);
                line.setAttribute('y1', segment.start.y);
                line.setAttribute('x2', segment.end.x);
                line.setAttribute('y2', segment.end.y);
            
                // ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨å±‚å·è€Œä¸æ˜¯æ•°å­—
                const layerClass = `metal${segment.layer}`;
                line.setAttribute('class', `fixed-wire ${layerClass}`);
                line.setAttribute('stroke-width', 2);
                line.setAttribute('stroke-dasharray', '5,3');
                line.setAttribute('data-wire-id', wire.id);
                canvas.appendChild(line);
            });
        
            // ç»˜åˆ¶è¿‡å­”
            if (wire.vias) {
                wire.vias.forEach(via => {
                    const viaElement = document.createElementNS(ns, 'circle');
                    viaElement.setAttribute('cx', via.x);
                    viaElement.setAttribute('cy', via.y);
                    viaElement.setAttribute('r', 3);
                    viaElement.setAttribute('class', 'fixed-via');
                    viaElement.setAttribute('fill', '#FF5722');
                    viaElement.setAttribute('data-wire-id', wire.id);
                    canvas.appendChild(viaElement);
                });
            }
        }
        
        function centerComponents() {
            if (components.length === 0) return;
            
            // è®¡ç®—æ‰€æœ‰å…ƒä»¶çš„è¾¹ç•Œ
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            components.forEach(comp => {
                minX = Math.min(minX, comp.x);
                minY = Math.min(minY, comp.y);
                maxX = Math.max(maxX, comp.x + (comp.type === 'nmos' || comp.type === 'pmos' ? gridSize*6 : 0));
                maxY = Math.max(maxY, comp.y + (comp.type === 'nmos' || comp.type === 'pmos' ? gridSize*4 : 0));
            });
            
            // è®¡ç®—ä¸­å¿ƒç‚¹
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;
            
            // è®¡ç®—è§†å£ä¸­å¿ƒ
            const containerRect = canvasContainer.getBoundingClientRect();
            const viewportCenterX = containerRect.width / 2;
            const viewportCenterY = containerRect.height / 2;
            
            // è°ƒæ•´å¹³ç§»é‡ä½¿å…ƒä»¶ä¸­å¿ƒä½äºè§†å£ä¸­å¿ƒ
            panX = viewportCenterX - centerX * zoomLevel;
            panY = viewportCenterY - centerY * zoomLevel;
            
            applyTransform();
        }
                
        function downloadJson() {
            let data, filename;
            
            switch(currentExportType) {
                case 'vjson':
                    data = generateCircuitJson();
                    filename = 'circuit_design.v.json';
                    break;
                case 'layout':
                    data = generateLayoutJson();
                    filename = 'Layout_after.json';
                    break;
                case 'route':
                    data = generateRouteJson();
                    filename = 'Route_after.json';
                    break;
            }
            
            if (!data) return;
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", filename);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            hideExportModal();
        }
        
        function generateCircuitJson() {
            // 1. æ„å»ºç½‘ç»œæ˜ å°„è¡¨ (ä½¿ç”¨è¿é€šå›¾ç®—æ³•)
            const pinMap = new Map(); // å¼•è„šåˆ°ç½‘ç»œçš„æ˜ å°„
            const nets = {}; // ç½‘ç»œIDåˆ°ç½‘ç»œå¯¹è±¡çš„æ˜ å°„
            
            // åˆå§‹åŒ–æ‰€æœ‰å¼•è„š
            components.forEach(comp => {
                comp.pins.forEach(pin => {
                    const pinId = `${pin.x},${pin.y}`;
                    pinMap.set(pinId, {
                        id: pinId,
                        compId: comp.id,
                        pinType: pin.type,
                        compType: comp.type,
                        compName: comp.name
                    });
                });
            });

            // è¿é€šå›¾ç®—æ³• - åˆå¹¶å¯¼çº¿è¿æ¥çš„ç½‘ç»œ
            wires.forEach(wire => {
                const startPinId = `${wire.start.x},${wire.start.y}`;
                const endPinId = `${wire.end.x},${wire.end.y}`;
                
                const startNet = pinMap.get(startPinId)?.netId;
                const endNet = pinMap.get(endPinId)?.netId;
                
                if (!startNet && !endNet) {
                    // åˆ›å»ºæ–°ç½‘ç»œ
                    const netId = `net_${Object.keys(nets).length + 1}`;
                    nets[netId] = {
                        id: netId,
                        pins: new Set([startPinId, endPinId]),
                        components: new Set(),
                        portTypes: new Set()
                    };
                    pinMap.get(startPinId).netId = netId;
                    pinMap.get(endPinId).netId = netId;
                } else if (startNet && !endNet) {
                    // å°†ç»ˆç‚¹åŠ å…¥èµ·ç‚¹ç½‘ç»œ
                    pinMap.get(endPinId).netId = startNet;
                    nets[startNet].pins.add(endPinId);
                } else if (!startNet && endNet) {
                    // å°†èµ·ç‚¹åŠ å…¥ç»ˆç‚¹ç½‘ç»œ
                    pinMap.get(startPinId).netId = endNet;
                    nets[endNet].pins.add(startPinId);
                } else if (startNet !== endNet) {
                    // åˆå¹¶ä¸¤ä¸ªç½‘ç»œ
                    const targetNet = nets[startNet];
                    const sourceNet = nets[endNet];
                    
                    // å°†æºç½‘ç»œçš„æ‰€æœ‰å¼•è„šè½¬ç§»åˆ°ç›®æ ‡ç½‘ç»œ
                    sourceNet.pins.forEach(pinId => {
                        pinMap.get(pinId).netId = startNet;
                        targetNet.pins.add(pinId);
                    });
                    
                    // åˆ é™¤æºç½‘ç»œ
                    delete nets[endNet];
                }
            });

            // 2. å¤„ç†æœªè¿æ¥çš„å¼•è„š
            pinMap.forEach((pinInfo, pinId) => {
                if (!pinInfo.netId) {
                    const netId = `net_${Object.keys(nets).length + 1}`;
                    pinInfo.netId = netId;
                    nets[netId] = {
                        id: netId,
                        pins: new Set([pinId]),
                        components: new Set(),
                        portTypes: new Set()
                    };
                }
            });

            // 3. æ„å»ºç½‘ç»œç»„ä»¶å…³ç³»
            pinMap.forEach(pinInfo => {
                const net = nets[pinInfo.netId];
                net.components.add(pinInfo.compId);
                
                // è®°å½•ç«¯å£ç±»å‹
                if (['input', 'output', 'vcc', 'gnd'].includes(pinInfo.compType)) {
                    net.portTypes.add(pinInfo.compType);
                }
            });

            // 4. ç¡®å®šç½‘ç»œåç§°å’Œç±»å‹
            const netMap = new Map(); // ç½‘ç»œIDåˆ°ç½‘ç»œåç§°çš„æ˜ å°„
            const portNets = {}; // ç«¯å£ç½‘ç»œ
            
            Object.values(nets).forEach(net => {
                let netName = net.id;
                let netType = 'wire';
                
                // ç¡®å®šç½‘ç»œç±»å‹å’Œåç§°
                if (net.portTypes.has('input')) {
                    netType = 'input';
                    // æŸ¥æ‰¾è¾“å…¥ç«¯å£åç§°
                    net.pins.forEach(pinId => {
                        const pinInfo = pinMap.get(pinId);
                        if (pinInfo.compType === 'input') {
                            netName = pinInfo.compName;
                        }
                    });
                } else if (net.portTypes.has('output')) {
                    netType = 'output';
                    // æŸ¥æ‰¾è¾“å‡ºç«¯å£åç§°
                    net.pins.forEach(pinId => {
                        const pinInfo = pinMap.get(pinId);
                        if (pinInfo.compType === 'output') {
                            netName = pinInfo.compName;
                        }
                    });
                } else if (net.portTypes.has('vcc')) {
                    netType = 'power';
                    netName = 'VCC';
                } else if (net.portTypes.has('gnd')) {
                    netType = 'power';
                    netName = 'GND';
                }
                
                netMap.set(net.id, netName);
                portNets[netName] = {
                    type: netType,
                    out: [],
                    in: []
                };
            });

            // 5. æ„å»ºç«¯å£è¿æ¥å…³ç³»
            Object.values(nets).forEach(net => {
                const netName = netMap.get(net.id);
                const portNet = portNets[netName];
                
                net.components.forEach(compId => {
                    const comp = components.find(c => c.id === compId);
                    if (!comp) return;
                    
                    // æ™¶ä½“ç®¡è¿æ¥
                    if (comp.type === 'nmos' || comp.type === 'pmos') {
                        if (portNet.type === 'input' || portNet.type === 'power') {
                            portNet.out.push(comp.name);
                        } else if (portNet.type === 'output') {
                            portNet.in.push(comp.name);
                        } else { // wireç±»å‹
                            // æ ¹æ®å¼•è„šç±»å‹ç¡®å®šè¿æ¥æ–¹å‘
                            net.pins.forEach(pinId => {
                                const pinInfo = pinMap.get(pinId);
                                if (pinInfo.compId === compId) {
                                    if (pinInfo.pinType === 'gate' || pinInfo.pinType === 'source') {
                                        portNet.out.push(comp.name);
                                    } else if (pinInfo.pinType === 'drain') {
                                        portNet.in.push(comp.name);
                                    }
                                }
                            });
                        }
                    }
                });
            });

            // 6. æ„å»ºç”µè·¯æè¿°
            const circuit = {
                "top_module": {
                    "type": "module",
                    "name": "top_module",
                    "ports": portNets,
                    "mosfets": {},
                    "subModules": {}
                }
            };
            
            // 7. æ„å»ºæ™¶ä½“ç®¡è¿æ¥
            components.filter(c => c.type === 'nmos' || c.type === 'pmos').forEach(transistor => {
                const transName = transistor.name;
                circuit.top_module.mosfets[transName] = {
                    type: transistor.type,
                    drain: '',
                    source: '',
                    gate: ''
                };
                
                // æŸ¥æ‰¾æ¯ä¸ªå¼•è„šè¿æ¥çš„ç½‘ç»œ
                transistor.pins.forEach(pin => {
                    const pinId = `${pin.x},${pin.y}`;
                    const pinInfo = pinMap.get(pinId);
                    if (pinInfo && pinInfo.netId) {
                        const netName = netMap.get(pinInfo.netId);
                        
                        if (pin.type === 'drain') {
                            circuit.top_module.mosfets[transName].drain = netName;
                        } else if (pin.type === 'source') {
                            circuit.top_module.mosfets[transName].source = netName;
                        } else if (pin.type === 'gate') {
                            circuit.top_module.mosfets[transName].gate = netName;
                        }
                    }
                });
            });
            
            return circuit;
        }

        function generateLayoutJson() {
            const layout = {
                "top_module": {
                    "inputPorts": [],
                    "isgnd": false,
                    "isvcc": false,
                    "layout": {
                        "height": 500,
                        "layer": 1,
                        "width": 800,
                        "x": 0,
                        "y": 0
                    },
                    "mosfets": {},
                    "name": "top_module",
                    "outputPorts": [],
                    "subModules": {},
                    "type": "module"
                }
            };
            
            // æ”¶é›†ç«¯å£
            components.filter(c => ['input', 'output', 'vcc', 'gnd'].includes(c.type)).forEach(port => {
                if (port.type === 'input') {
                    layout.top_module.inputPorts.push(port.name);
                } else if (port.type === 'output') {
                    layout.top_module.outputPorts.push(port.name);
                }
                
                if (port.type === 'vcc') layout.top_module.isvcc = true;
                if (port.type === 'gnd') layout.top_module.isgnd = true;
            });
            
            // æ”¶é›†æ™¶ä½“ç®¡
            components.filter(c => c.type === 'nmos' || c.type === 'pmos').forEach(transistor => {
                layout.top_module.mosfets[transistor.name] = {
                    type: transistor.type,
                    drain: "",
                    source: "",
                    gate: "",
                    layout: {
                        height: gridSize*4,
                        layer: 1,
                        width: gridSize*6,
                        x: transistor.x,
                        y: transistor.y
                    }
                };
            });
            
            return layout;
        }
        
        function generateRouteJson() {
            const route = {
                "top_module": {
                    "module_name": "top_module",
                    "name": "top_module",
                    "nets": [],
                    "subModules": {}
                }
            };
            
            // æ”¶é›†è¿çº¿
            wires.forEach((wire, index) => {
                const net = {
                    name: `net_${index + 1}`,
                    pins: [
                        { layer: 1, x: wire.start.x, y: wire.start.y },
                        { layer: 1, x: wire.end.x, y: wire.end.y }
                    ],
                    segments: [],
                    vias: []
                };
                
                // æ·»åŠ çº¿æ®µ
                wire.segments.forEach(segment => {
                    net.segments.push({
                        start: { x: segment.start.x, y: segment.start.y },
                        end: { x: segment.end.x, y: segment.end.y },
                        layer: segment.layer === 'metal1' ? 1 : 
                               segment.layer === 'metal2' ? 2 : 
                               segment.layer === 'metal3' ? 3 : 
                               segment.layer === 'metal4' ? 4 : 
                               5
                    });
                });
                
                // æ·»åŠ è¿‡å­”
                wire.vias.forEach(via => {
                    net.vias.push({ x: via.x, y: via.y });
                });
                
                route.top_module.nets.push(net);
            });
            
            return route;
        }
        
        function clearCanvas() {
            // æ¸…ç©ºå…ƒä»¶
            components.forEach(comp => {
                document.querySelectorAll(`[data-id='${comp.id}']`).forEach(el => el.remove());
                document.querySelectorAll(`.component-label[data-parent='${comp.id}']`).forEach(el => el.remove());
                document.querySelectorAll(`.pin[data-parent='${comp.id}']`).forEach(el => el.remove());
            });
            components = [];
            
            // æ¸…ç©ºè¿çº¿
            wires.forEach(wire => {
                document.querySelectorAll(`[data-wire-id='${wire.id}']`).forEach(el => el.remove());
            });
            wires = [];
            
            updateStats();
        }
    </script>
</body>
</html>